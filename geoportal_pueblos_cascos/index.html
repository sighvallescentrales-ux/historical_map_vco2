<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Geoportal – Pueblos y Cascos</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;height:100%}
#map{height:100%}

.topbar{
  position:absolute; top:10px; left:50%;
  transform:translateX(-50%);
  z-index:1000;
  background:white;
  padding:8px 10px;
  border-radius:10px;
  box-shadow:0 4px 14px rgba(0,0,0,.2);
  font:13px system-ui;
}
.topbar select,.topbar input,.topbar button{
  padding:5px 6px; font-size:13px;
}

.distLabel{
  background: transparent;
  border: none;
  box-shadow: none;
  color: #222;
  font-weight: 700;
  font-size: 12px;
  text-shadow: 0 1px 2px rgba(255,255,255,.9);
}
</style>
</head>

<body>
<div id="map"></div>

<div class="topbar">
  Capa:
  <select id="searchLayer">
    <option value="cascos">Cascos</option>
    <option value="pueblos">Pueblos</option>
  </select>

  Campo:
  <select id="searchField"></select>

  <input id="searchInput" placeholder="Escribe y elige…" list="searchList">
  <datalist id="searchList"></datalist>

  <button id="searchBtn">Ir</button>
  <button id="clearBtn">Limpiar</button>
</div>

<script>
// ===================
// Mapa base (DEFAULT = Satélite)
// ===================
const map = L.map("map").setView([17.05,-96.72],10);

// Satélite primero y agregado al mapa (DEFAULT)
const sat = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { attribution:"© Esri" }
).addTo(map);

// OSM disponible pero NO activado por defecto
const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  attribution:"© OpenStreetMap"
});

// ===================
// Panes (orden visual)
// ===================
map.createPane("distritos");  map.getPane("distritos").style.zIndex=200;
map.createPane("municipios"); map.getPane("municipios").style.zIndex=300;
map.createPane("tenencia");   map.getPane("tenencia").style.zIndex=400;
map.createPane("puntos");     map.getPane("puntos").style.zIndex=500;

// ===================
// ESTILOS
// ===================

// Distritos – gris transparente
const styleDistritos={
  pane:"distritos",
  color:"#555",
  weight:1.5,
  fillColor:"#bdbdbd",
  fillOpacity:.20
};

// Municipios – solo borde
const styleMunicipios={
  pane:"municipios",
  color:"#000",
  weight:1.2,
  fillOpacity:0
};

// Ejidos – verde
const styleEjidos={
  pane:"tenencia",
  color:"#1b7837",
  weight:1.2,
  fillColor:"#5aae61",
  fillOpacity:.35
};

// Comunal – MORADO (pedido)
const styleComunal={
  pane:"tenencia",
  color:"#5e3c99",
  weight:1.2,
  fillColor:"#8e6bd1",
  fillOpacity:.35
};

// ===================
// ICONO "Pin" para Cascos (más atractivo)
// ===================
function cascoIcon(){
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28">
    <path d="M14 1.5c-5.1 0-9.2 4.1-9.2 9.2 0 6.8 9.2 15.8 9.2 15.8s9.2-9 9.2-15.8c0-5.1-4.1-9.2-9.2-9.2z"
          fill="#c62828" stroke="#111" stroke-width="1.2"/>
    <circle cx="14" cy="10.7" r="3.4" fill="#fff" stroke="#111" stroke-width="1"/>
    <path d="M10.2 16.2h7.6" stroke="#fff" stroke-width="1.6" stroke-linecap="round" opacity="0.9"/>
  </svg>`;
  return L.divIcon({
    className: "",
    html: svg,
    iconSize: [28, 28],
    iconAnchor: [14, 26],  // punta del pin
    popupAnchor: [0, -24]
  });
}

const CASCO_ICON = cascoIcon();

// ===================
// Helpers
// ===================
async function load(url){
  const r=await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error("No se pudo cargar: "+url);
  return await r.json();
}

const idx={
  pueblos:{NOMGEO:new Map()},
  cascos:{Hacienda:new Map(),Distrito:new Map(),Municipio:new Map()}
};

function addIdx(tipo,campo,val,layer){
  if(val===null || val===undefined) return;
  const v = String(val).trim();
  if(!v) return;
  const k = v.toLowerCase();
  if(!idx[tipo][campo].has(k)) idx[tipo][campo].set(k,[]);
  idx[tipo][campo].get(k).push(layer);
}

// ===================
// Cargar capas
// ===================
(async()=>{

// ---- Distritos (DEFAULT ON)
const distritos=L.geoJSON(await load("data/distritos.geojson"),{
  style:styleDistritos,
  onEachFeature:(f,l)=>{
    const p=f.properties||{};
    const titulo = p.Nombre ?? p.nombre ?? "Distrito";
    const desc = p["Descripción"] ?? p["Descripcion"] ?? p.descripcion ?? "";
    l.bindPopup(`<b>${titulo}</b>${desc ? `<br>${desc}` : ""}`);

    // etiqueta al centro
    if(titulo){
      l.bindTooltip(String(titulo),{
        permanent:true,
        direction:"center",
        className:"distLabel"
      });
    }
  }
}).addTo(map);

// ---- Municipios (DEFAULT OFF)
const municipios=L.geoJSON(await load("data/municipios.geojson"),{
  style:styleMunicipios
}); // NO addTo(map)

// ---- Ejidos (DEFAULT OFF)
const ejidos=L.geoJSON(await load("data/ejidos.geojson"),{
  style:styleEjidos
}); // NO addTo(map)

// ---- Comunal (DEFAULT OFF, MORADO)
const comunal=L.geoJSON(await load("data/comunal.geojson"),{
  style:styleComunal
}); // NO addTo(map)

// ---- Pueblos (DEFAULT ON)
const pueblos=L.geoJSON(await load("data/pueblos.geojson"),{
  pointToLayer:(f,ll)=>L.circleMarker(ll,{
    pane:"puntos",radius:6,color:"#111",
    fillColor:"#ffd700",fillOpacity:.92,weight:1.2
  }),
  onEachFeature:(f,l)=>{
    const p=f.properties||{};
    const nom = p.NOMGEO ?? p.nomgeo ?? "Sin nombre";
    const amb = p.AMBITO ?? p.ambito ?? "s/d";
    const url=`ficha.html?tipo=pueblos&campo=NOMGEO&valor=${encodeURIComponent(nom)}`;
    l.bindPopup(`
      <b>${nom}</b><br>
      Ámbito: ${amb}<br><br>
      <a href="${url}" target="_blank" rel="noopener">Ver ficha</a>
    `);
    addIdx("pueblos","NOMGEO",nom,l);
  }
}).addTo(map);

// ---- Cascos (DEFAULT ON) con PIN SVG
const cascos=L.geoJSON(await load("data/cascos_haciendas.geojson"),{
  pointToLayer:(f,ll)=>L.marker(ll,{icon:CASCO_ICON, pane:"puntos"}),
  onEachFeature:(f,l)=>{
    const p=f.properties||{};
    const hac = p.Hacienda ?? p.hacienda ?? "Sin nombre";
    const dis = p.Distrito ?? p.distrito ?? "s/d";
    const mun = p.Municipio ?? p.municipio ?? "s/d";
    const url=`ficha.html?tipo=cascos&campo=Hacienda&valor=${encodeURIComponent(hac)}`;
    l.bindPopup(`
      <b>${hac}</b><br>
      Distrito: ${dis}<br>
      Municipio: ${mun}<br><br>
      <a href="${url}" target="_blank" rel="noopener">Ver ficha</a>
    `);

    addIdx("cascos","Hacienda",hac,l);
    addIdx("cascos","Distrito",dis,l);
    addIdx("cascos","Municipio",mun,l);
  }
}).addTo(map);

// ===================
// Control de capas
// ===================
L.control.layers(
  {"Satélite":sat, "OSM":osm},
  {
    "Distritos":distritos,
    "Municipios":municipios,
    "Ejidos":ejidos,
    "Comunal":comunal,
    "Pueblos":pueblos,
    "Cascos de hacienda":cascos
  },
  {collapsed:false}
).addTo(map);

// Vista inicial: distritos
map.fitBounds(distritos.getBounds(), {padding:[20,20]});

// ===================
// Buscador
// ===================
const layerSel=document.getElementById("searchLayer");
const fieldSel=document.getElementById("searchField");
const input=document.getElementById("searchInput");
const list=document.getElementById("searchList");

function refreshFields(){
  fieldSel.innerHTML="";
  const t=layerSel.value;
  // orden fijo para que sea cómodo
  const fields = (t==="cascos") ? ["Hacienda","Distrito","Municipio"] : ["NOMGEO"];
  fields.forEach(k=>{
    const o=document.createElement("option");
    o.value=k;o.textContent=k;
    fieldSel.appendChild(o);
  });
  refreshList();
}
function refreshList(){
  list.innerHTML="";
  const t=layerSel.value,c=fieldSel.value;
  const m = idx[t][c];
  if(!m) return;
  [...m.keys()].sort((a,b)=>a.localeCompare(b,"es",{sensitivity:"base"})).forEach(k=>{
    const o=document.createElement("option");
    o.value=k; list.appendChild(o);
  });
}

document.getElementById("searchBtn").onclick=()=>{
  const t=layerSel.value,c=fieldSel.value;
  const v=String(input.value||"").trim().toLowerCase();
  if(!v) return;
  const m = idx[t][c];
  if(m && m.has(v)){
    const ls=m.get(v);
    const fg=L.featureGroup(ls);
    map.fitBounds(fg.getBounds(), {padding:[30,30]});
    ls[0].openPopup?.();
  }else{
    alert("No encontré coincidencias exactas. Elige del listado para evitar errores.");
  }
};
document.getElementById("clearBtn").onclick=()=>input.value="";
layerSel.onchange=refreshFields;
fieldSel.onchange=refreshList;

refreshFields();

})();
</script>
</body>
</html>
