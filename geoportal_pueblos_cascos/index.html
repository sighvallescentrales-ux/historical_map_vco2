<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Geoportal - Pueblos y Cascos</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body { height:100%; margin:0; }
#map { height:100%; }

/* Barra superior */
.topbar{
  position:absolute;
  top:12px; left:12px; right:12px;
  z-index:1000;
  pointer-events:none;
}
.panel{
  pointer-events:auto;
  background:#ffffffee;
  border:1px solid #ddd;
  border-radius:12px;
  padding:10px 12px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  font:13px system-ui;
}
.panel label{ font-weight:700; }
.panel select, .panel input, .panel button{
  padding:6px 8px;
  border-radius:8px;
  border:1px solid #ccc;
}
.panel button{ cursor:pointer; }

/* evita que el buscador tape controles */
.leaflet-top.leaflet-right,
.leaflet-top.leaflet-left { top:100px; }

.leaflet-control { z-index:1100; }
</style>
</head>

<body>
<div id="map"></div>

<!-- BUSCADOR -->
<div class="topbar">
  <div class="panel">
    <label>Capa</label>
    <select id="searchLayer">
      <option value="cascos">Cascos</option>
      <option value="pueblos">Pueblos</option>
    </select>

    <label>Campo</label>
    <select id="searchField"></select>

    <input id="searchInput" list="searchList" placeholder="Escribe y elige…" />
    <datalist id="searchList"></datalist>

    <button id="searchBtn">Ir</button>
    <button id="clearBtn">Limpiar</button>
  </div>
</div>

<script>
// ================== HELPERS ==================
function openFicha(tipo, campo, valor){
  const v = (valor ?? "").toString().trim();
  if(!v) return;
  const url = `ficha.html?tipo=${encodeURIComponent(tipo)}&campo=${encodeURIComponent(campo)}&valor=${encodeURIComponent(v)}`;
  window.open(url, "_blank", "noopener");
}

// ================== MAPA BASE ==================
const map = L.map("map").setView([17.07, -96.73], 9);

const osm = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { maxZoom:19, attribution:"© OpenStreetMap" }
).addTo(map);

const sat = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { maxZoom:19, attribution:"© Esri" }
);

// ================== PANES ==================
map.createPane("distritos");  map.getPane("distritos").style.zIndex = 200;
map.createPane("municipios"); map.getPane("municipios").style.zIndex = 300;
map.createPane("tenencia");   map.getPane("tenencia").style.zIndex = 400;
map.createPane("puntos");     map.getPane("puntos").style.zIndex = 500;

// ================== ESTILOS ==================
const styleDistritos  = { pane:"distritos",  color:"#555", fillOpacity:0.1 };
const styleMunicipios = { pane:"municipios", color:"#333", fillOpacity:0.1 };
const styleEjidos     = { pane:"tenencia",   color:"#1f6f3b", fillOpacity:0.15 };
const styleComunal    = { pane:"tenencia",   color:"#1b4f72", fillOpacity:0.15 };

function marker(color){
  return (f,latlng)=>L.circleMarker(latlng,{
    pane:"puntos", radius:6, color:"#222",
    fillColor:color, fillOpacity:0.9
  });
}

// ================== BUSCADOR ==================
const FIELDS = {
  pueblos: ["NOMGEO"],
  cascos: ["Hacienda","Distrito","Municipio"]
};

const idx = {
  pueblos:{ NOMGEO:new Map() },
  cascos:{
    Hacienda:new Map(),
    Distrito:new Map(),
    Municipio:new Map()
  }
};

function addIdx(tipo,campo,valor,layer){
  if(!valor) return;
  const k = valor.toLowerCase();
  if(!idx[tipo][campo].has(k)) idx[tipo][campo].set(k,[]);
  idx[tipo][campo].get(k).push(layer);
}

// ================== RESALTADO ==================
let halo=null;
function highlight(ll){
  if(halo) map.removeLayer(halo);
  halo=L.circleMarker(ll,{radius:14,color:"#000",fillOpacity:0}).addTo(map);
}
function clearHighlight(){
  if(halo) map.removeLayer(halo); halo=null;
}

// ================== CARGA DATOS ==================
async function load(url){
  const r = await fetch(url, { cache:"no-store" });
  if(!r.ok) throw new Error(url);
  return r.json();
}

const overlays = {};

(async ()=>{
// Distritos
const distritos = L.geoJSON(await load("data/distritos.geojson"),{
  style:styleDistritos
}).addTo(map);
overlays["Distritos"]=distritos;

// Municipios
const municipios = L.geoJSON(await load("data/municipios.geojson"),{
  style:styleMunicipios
}).addTo(map);
overlays["Municipios"]=municipios;

// Ejidos
const ejidos = L.geoJSON(await load("data/ejidos.geojson"),{
  style:styleEjidos
}).addTo(map);
overlays["Ejidos"]=ejidos;

// Comunal
const comunal = L.geoJSON(await load("data/comunal.geojson"),{
  style:styleComunal
}).addTo(map);
overlays["Comunal"]=comunal;

// Pueblos
const pueblos = L.geoJSON(await load("data/pueblos.geojson"),{
  pointToLayer:marker("#ffcc00"),
  onEachFeature:(f,l)=>{
    const p = f.properties || {};
    l.bindPopup(`<b>${p.NOMGEO ?? "Sin nombre"}</b>`);

    addIdx("pueblos","NOMGEO",p.NOMGEO,l);

    // ✅ ABRIR FICHA (clic)
    l.on("click", (e)=>{
      // Si quieres que primero se vea el popup y luego abrir,
      // puedes cambiar a dblclick. Por ahora: clic abre ficha.
      openFicha("pueblos", "NOMGEO", p.NOMGEO);
    });

    // Alternativa (mejor UX): doble clic abre ficha
    // l.on("dblclick", (e)=>{
    //   L.DomEvent.stop(e);
    //   openFicha("pueblos", "NOMGEO", p.NOMGEO);
    // });
  }
}).addTo(map);
overlays["Pueblos"]=pueblos;

// Cascos
const cascos = L.geoJSON(await load("data/cascos_haciendas.geojson"),{
  pointToLayer:marker("#ff4d4d"),
  onEachFeature:(f,l)=>{
    const p=f.properties || {};
    l.bindPopup(`<b>${p.Hacienda ?? "Sin nombre"}</b><br>${p.Municipio ?? ""}`);

    addIdx("cascos","Hacienda",p.Hacienda,l);
    addIdx("cascos","Distrito",p.Distrito,l);
    addIdx("cascos","Municipio",p.Municipio,l);

    // ✅ ABRIR FICHA (clic)
    l.on("click", (e)=>{
      openFicha("cascos", "Hacienda", p.Hacienda);
    });

    // Alternativa (mejor UX): doble clic abre ficha
    // l.on("dblclick", (e)=>{
    //   L.DomEvent.stop(e);
    //   openFicha("cascos", "Hacienda", p.Hacienda);
    // });
  }
}).addTo(map);
overlays["Cascos de hacienda"]=cascos;

// CONTROL DE CAPAS
L.control.layers(
  { "OSM":osm, "Satélite":sat },
  overlays,
  { collapsed:false }
).addTo(map);

// Vista inicial
map.fitBounds(
  L.featureGroup([distritos,municipios,ejidos,comunal,pueblos,cascos]).getBounds()
);

// ================== BUSCADOR ==================
const selLayer=document.getElementById("searchLayer");
const selField=document.getElementById("searchField");
const input=document.getElementById("searchInput");
const list=document.getElementById("searchList");

function refreshFields(){
  selField.innerHTML="";
  FIELDS[selLayer.value].forEach(f=>{
    const o=document.createElement("option");
    o.value=f; o.textContent=f;
    selField.appendChild(o);
  });
  refreshList();
}
function refreshList(){
  list.innerHTML=""; input.value="";
  idx[selLayer.value][selField.value].forEach((v,k)=>{
    const o=document.createElement("option");
    o.value=k; list.appendChild(o);
  });
}
function doSearch(){
  clearHighlight();
  const m=idx[selLayer.value][selField.value];
  const r=m.get(input.value.toLowerCase());
  if(!r) return alert("Elige del listado");
  if(r.length===1){
    const ll=r[0].getLatLng();
    map.setView(ll,14); highlight(ll); r[0].openPopup();
  }else{
    map.fitBounds(L.featureGroup(r).getBounds());
  }
}

document.getElementById("searchBtn").onclick=doSearch;
document.getElementById("clearBtn").onclick=()=>{input.value="";clearHighlight();};
selLayer.onchange=refreshFields;
selField.onchange=refreshList;

refreshFields();
})().catch(err=>{
  console.error(err);
  alert("Error cargando capas. Revisa consola (F12) y rutas en /data.");
});
</script>
</body>
</html>
