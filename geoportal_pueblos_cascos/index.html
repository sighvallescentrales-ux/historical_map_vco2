<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Geoportal – Pueblos y Cascos</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;height:100%}
#map{height:100%}

.topbar{
  position:absolute; top:10px; left:50%;
  transform:translateX(-50%);
  z-index:1000;
  background:white;
  padding:8px 10px;
  border-radius:10px;
  box-shadow:0 4px 14px rgba(0,0,0,.2);
  font:13px system-ui;
}
.topbar select,.topbar input,.topbar button{
  padding:5px 6px; font-size:13px;
}
</style>
</head>

<body>
<div id="map"></div>

<div class="topbar">
  Capa:
  <select id="searchLayer">
    <option value="cascos">Cascos</option>
    <option value="pueblos">Pueblos</option>
  </select>

  Campo:
  <select id="searchField"></select>

  <input id="searchInput" placeholder="Escribe y elige…" list="searchList">
  <datalist id="searchList"></datalist>

  <button id="searchBtn">Ir</button>
  <button id="clearBtn">Limpiar</button>
</div>

<script>
// ===================
// Mapa base
// ===================
const map = L.map("map").setView([17.05,-96.72],10);

const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  attribution:"© OpenStreetMap"
}).addTo(map);

const sat = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { attribution:"© Esri" }
);

// ===================
// Panes
// ===================
map.createPane("distritos"); map.getPane("distritos").style.zIndex=200;
map.createPane("municipios"); map.getPane("municipios").style.zIndex=300;
map.createPane("tenencia"); map.getPane("tenencia").style.zIndex=400;
map.createPane("puntos"); map.getPane("puntos").style.zIndex=500;

// ===================
// ESTILOS CORREGIDOS
// ===================

// Distritos – gris transparente
const styleDistritos={
  pane:"distritos",
  color:"#555",
  weight:1.5,
  fillColor:"#bdbdbd",
  fillOpacity:.20
};

// Municipios – solo borde
const styleMunicipios={
  pane:"municipios",
  color:"#000",
  weight:1.2,
  fillOpacity:0
};

// Ejidos – verde
const styleEjidos={
  pane:"tenencia",
  color:"#1b7837",
  weight:1.2,
  fillColor:"#5aae61",
  fillOpacity:.35
};

// Comunal – azul verdoso
const styleComunal={
  pane:"tenencia",
  color:"#2166ac",
  weight:1.2,
  fillColor:"#67a9cf",
  fillOpacity:.35
};

// ===================
// Helpers
// ===================
async function load(url){
  const r=await fetch(url);
  return await r.json();
}
const idx={
  pueblos:{NOMGEO:new Map()},
  cascos:{Hacienda:new Map(),Distrito:new Map(),Municipio:new Map()}
};
function addIdx(tipo,campo,val,layer){
  if(!val)return;
  val=val.toLowerCase();
  if(!idx[tipo][campo].has(val))idx[tipo][campo].set(val,[]);
  idx[tipo][campo].get(val).push(layer);
}

// ===================
// Cargar capas
// ===================
(async()=>{

// Distritos
const distritos=L.geoJSON(await load("data/distritos.geojson"),{
  style:styleDistritos,
  onEachFeature:(f,l)=>{
    l.bindPopup(`<b>${f.properties.Nombre}</b><br>${f.properties.Descripción||""}`);
    l.bindTooltip(f.properties.Nombre,{
      permanent:true,
      direction:"center",
      className:"distLabel"
    });
  }
}).addTo(map);

// Municipios
const municipios=L.geoJSON(await load("data/municipios.geojson"),{
  style:styleMunicipios
}).addTo(map);

// Ejidos
const ejidos=L.geoJSON(await load("data/ejidos.geojson"),{
  style:styleEjidos
}).addTo(map);

// Comunal
const comunal=L.geoJSON(await load("data/comunal.geojson"),{
  style:styleComunal
}).addTo(map);

// Pueblos
const pueblos=L.geoJSON(await load("data/pueblos.geojson"),{
  pointToLayer:(f,ll)=>L.circleMarker(ll,{
    pane:"puntos",radius:6,color:"#000",
    fillColor:"#ffd700",fillOpacity:.9
  }),
  onEachFeature:(f,l)=>{
    const p=f.properties;
    const url=`ficha.html?tipo=pueblos&campo=NOMGEO&valor=${encodeURIComponent(p.NOMGEO)}`;
    l.bindPopup(`
      <b>${p.NOMGEO}</b><br>
      Ámbito: ${p.AMBITO}<br><br>
      <a href="${url}" target="_blank">Ver ficha</a>
    `);
    addIdx("pueblos","NOMGEO",p.NOMGEO,l);
  }
}).addTo(map);

// Cascos
const cascos=L.geoJSON(await load("data/cascos_haciendas.geojson"),{
  pointToLayer:(f,ll)=>L.circleMarker(ll,{
    pane:"puntos",radius:6,color:"#000",
    fillColor:"#c62828",fillOpacity:.9
  }),
  onEachFeature:(f,l)=>{
    const p=f.properties;
    const url=`ficha.html?tipo=cascos&campo=Hacienda&valor=${encodeURIComponent(p.Hacienda)}`;
    l.bindPopup(`
      <b>${p.Hacienda}</b><br>
      Distrito: ${p.Distrito}<br>
      Municipio: ${p.Municipio}<br><br>
      <a href="${url}" target="_blank">Ver ficha</a>
    `);
    addIdx("cascos","Hacienda",p.Hacienda,l);
    addIdx("cascos","Distrito",p.Distrito,l);
    addIdx("cascos","Municipio",p.Municipio,l);
  }
}).addTo(map);

// Control de capas
L.control.layers(
  {OSM:osm,"Satélite":sat},
  {
    Distritos:distritos,
    Municipios:municipios,
    Ejidos:ejidos,
    Comunal:comunal,
    Pueblos:pueblos,
    "Cascos de hacienda":cascos
  },
  {collapsed:false}
).addTo(map);

// Ajustar vista
map.fitBounds(distritos.getBounds());


// ===================
// Buscador
// ===================
const layerSel=document.getElementById("searchLayer");
const fieldSel=document.getElementById("searchField");
const input=document.getElementById("searchInput");
const list=document.getElementById("searchList");

function refreshFields(){
  fieldSel.innerHTML="";
  const t=layerSel.value;
  for(const k in idx[t]){
    const o=document.createElement("option");
    o.value=k;o.textContent=k;
    fieldSel.appendChild(o);
  }
  refreshList();
}
function refreshList(){
  list.innerHTML="";
  const t=layerSel.value,c=fieldSel.value;
  idx[t][c].forEach((_,k)=>{
    const o=document.createElement("option");
    o.value=k; list.appendChild(o);
  });
}
document.getElementById("searchBtn").onclick=()=>{
  const t=layerSel.value,c=fieldSel.value;
  const v=input.value.toLowerCase();
  if(idx[t][c].has(v)){
    const ls=idx[t][c].get(v);
    map.fitBounds(L.featureGroup(ls).getBounds());
    ls[0].openPopup();
  }
};
document.getElementById("clearBtn").onclick=()=>input.value="";
layerSel.onchange=refreshFields;
fieldSel.onchange=refreshList;
refreshFields();

})();
</script>
</body>
</html>
