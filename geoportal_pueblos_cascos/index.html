<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Geoportal · Pueblos y Cascos de Hacienda</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{margin:0;height:100%}
#map{height:100%}

/* Panel superior */
#panel{
  position:absolute;
  top:10px; left:50%;
  transform:translateX(-50%);
  z-index:1000;
  background:#fff;
  padding:8px 10px;
  border-radius:10px;
  box-shadow:0 4px 18px rgba(0,0,0,.15);
  font:14px system-ui;
  display:flex;
  gap:6px;
  align-items:center;
}

/* Etiquetas de distritos */
.district-label div{
  font:700 12px system-ui;
  color:#111;
  background:rgba(255,255,255,.85);
  border:1px solid rgba(0,0,0,.15);
  padding:2px 6px;
  border-radius:8px;
  box-shadow:0 3px 10px rgba(0,0,0,.10);
  white-space:nowrap;
  pointer-events:none;
}
</style>
</head>

<body>

<div id="panel">
  <label>Capa</label>
  <select id="layerSelect">
    <option value="cascos">Cascos</option>
    <option value="pueblos">Pueblos</option>
  </select>

  <label>Campo</label>
  <select id="fieldSelect"></select>

  <input id="searchInput" placeholder="Escribe y elige…" size="18"/>
  <button id="goBtn">Ir</button>
  <button id="clearBtn">Limpiar</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map = L.map("map").setView([17.05,-96.72],10);

/* ================= MAPAS BASE ================= */
const osm = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  {attribution:"© OpenStreetMap"}
).addTo(map);

const sat = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  {attribution:"© Esri"}
);

/* ================= HELPERS ================= */
async function load(url){
  return await fetch(url).then(r=>r.json());
}

/* ================= ESTILOS ================= */
const styleDistritos = {
  color:"#1b4d2b",
  weight:2,
  fillColor:"#4c8c6a",
  fillOpacity:.15
};

const styleMunicipios = {color:"#000",weight:1.5,fillOpacity:0};
const styleEjidos = {color:"#1e6b3c",weight:1,fillOpacity:.12};
const styleComunal = {color:"#2e8b57",weight:1,fillOpacity:.12};

/* ================= CARGA DE CAPAS ================= */
(async()=>{

/* ---- DISTRITOS (con etiquetas PRO) ---- */
const districtLabels = [];
const minLabelZoom = 11;

const distritos = L.geoJSON(await load("data/distritos.geojson"),{
  style:styleDistritos,
  onEachFeature:(f,layer)=>{
    const p=f.properties||{};
    const nombre = p.Nombre ?? p.nombre ?? "s/d";

    layer.bindPopup(`
      <b>${nombre}</b><br>
      <b>NOM_DIST:</b> ${p.NOM_DIST ?? "s/d"}<br>
      <b>Descripción:</b> ${p.Descripción ?? "s/d"}<br>
      <b>Mapa estático:</b> ${p["Mapa estático"] ?? "s/d"}
    `);

    const center = layer.getBounds().getCenter();
    const lbl = L.marker(center,{
      icon:L.divIcon({
        className:"district-label",
        html:`<div>${nombre}</div>`
      }),
      interactive:false
    });

    districtLabels.push(lbl);

    layer.on("mouseover",()=>layer.setStyle({fillOpacity:.25}));
    layer.on("mouseout",()=>distritos.resetStyle(layer));
  }
}).addTo(map);

/* Control de zoom para etiquetas */
map.on("zoomend",()=>{
  if(map.getZoom()>=minLabelZoom){
    districtLabels.forEach(l=>l.addTo(map));
  }else{
    districtLabels.forEach(l=>map.removeLayer(l));
  }
});

/* ---- MUNICIPIOS ---- */
const municipios = L.geoJSON(await load("data/municipios.geojson"),{
  style:styleMunicipios
}).addTo(map);

/* ---- EJIDOS ---- */
const ejidos = L.geoJSON(await load("data/ejidos.geojson"),{
  style:styleEjidos
}).addTo(map);

/* ---- COMUNAL ---- */
const comunal = L.geoJSON(await load("data/comunal.geojson"),{
  style:styleComunal
}).addTo(map);

/* ---- PUEBLOS ---- */
const pueblosData = await load("data/pueblos.geojson");
const pueblos = L.geoJSON(pueblosData,{
  pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
    radius:6,color:"#000",fillColor:"#ffd700",fillOpacity:.9
  }),
  onEachFeature:(f,l)=>{
    l.bindPopup(`<b>${f.properties.NOMGEO}</b>`);
  }
}).addTo(map);

/* ---- CASCOS ---- */
const cascosData = await load("data/cascos_haciendas.geojson");
const cascos = L.geoJSON(cascosData,{
  pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
    radius:6,color:"#000",fillColor:"#c62828",fillOpacity:.9
  }),
  onEachFeature:(f,l)=>{
    l.bindPopup(`
      <b>${f.properties.Hacienda}</b><br>
      ${f.properties.Municipio}
    `);
  }
}).addTo(map);

/* ================= CONTROL DE CAPAS ================= */
L.control.layers(
  {"OSM":osm,"Satélite":sat},
  {
    "Distritos":distritos,
    "Municipios":municipios,
    "Ejidos":ejidos,
    "Comunal":comunal,
    "Pueblos":pueblos,
    "Cascos de hacienda":cascos
  },
  {collapsed:false}
).addTo(map);

/* ================= BUSCADOR ================= */
const layerSelect=document.getElementById("layerSelect");
const fieldSelect=document.getElementById("fieldSelect");
const searchInput=document.getElementById("searchInput");

function updateFields(){
  fieldSelect.innerHTML="";
  if(layerSelect.value==="cascos"){
    ["Hacienda","Distrito","Municipio"].forEach(f=>{
      fieldSelect.innerHTML+=`<option>${f}</option>`;
    });
  }else{
    fieldSelect.innerHTML+=`<option>NOMGEO</option>`;
  }
}
updateFields();
layerSelect.onchange=updateFields;

document.getElementById("goBtn").onclick=()=>{
  const val=searchInput.value.toLowerCase();
  const layer = layerSelect.value==="cascos" ? cascos : pueblos;
  const field = fieldSelect.value;

  layer.eachLayer(l=>{
    const p=l.feature.properties;
    if(p[field] && p[field].toLowerCase().includes(val)){
      map.setView(l.getLatLng(),14);
      l.openPopup();
    }
  });
};

document.getElementById("clearBtn").onclick=()=>{
  searchInput.value="";
  map.closePopup();
};

})();
</script>
</body>
</html>
