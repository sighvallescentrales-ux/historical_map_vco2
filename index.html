<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const map = L.map("map", { center:[17.046,-96.635], zoom:14 });

  /* MAPAS BASE */
  const base = {
    osm: L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {maxZoom:20, attribution:"© OpenStreetMap"}),
    opentopo: L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
      {maxZoom:18, attribution:"© OpenTopoMap"}),
    esri: L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {maxZoom:20, attribution:"© Esri, Maxar"})
  };

  // Base inicial: OpenTopo
  base.opentopo.addTo(map);

  document.getElementById("base").addEventListener("change", e=>{
    Object.values(base).forEach(l=>map.removeLayer(l));
    base[e.target.value].addTo(map);
  });

  /* MAPAS HISTÓRICOS: SOLO 2 HACIENDAS */
  const overlayConfigs = [
    {
      id: "aranjuez",
      nombre: "Hacienda Aranjuez",
      url: "./tiles_aranjuez/{z}/{x}/{y}.png",
      opacidadInicial: 0.6,
      minZoom: 12,
      maxZoom: 18
    },
    {
      id: "prio",
      nombre: "Hacienda Prio",
      url: "./tiles_prio/{z}/{x}/{y}.png",
      opacidadInicial: 0.6,
      minZoom: 12,
      maxZoom: 18
    }
  ];

  const overlayLayers = {};
  const overlaysDiv = document.getElementById("overlays");

  overlayConfigs.forEach(cfg => {
    const layer = L.tileLayer(cfg.url, {
      opacity: cfg.opacidadInicial,
      minZoom: cfg.minZoom,
      maxZoom: cfg.maxZoom,
      // cambia a true solo si ves las teselas invertidas verticalmente
      tms: false
    });

    // NO se agrega al mapa por defecto: se activa con el checkbox
    overlayLayers[cfg.id] = layer;

    const row = document.createElement("div");
    row.className = "overlay-row";

    row.innerHTML = `
      <label>
        <input type="checkbox" data-id="${cfg.id}">
        ${cfg.nombre}
      </label>
      <input type="range" min="0" max="1" step="0.05"
             value="${cfg.opacidadInicial}" data-id="${cfg.id}">
    `;

    overlaysDiv.appendChild(row);

    const chk = row.querySelector('input[type="checkbox"]');
    const rng = row.querySelector('input[type="range"]');

    chk.addEventListener("change", e => {
      const lyr = overlayLayers[e.target.dataset.id];
      if (e.target.checked){
        lyr.addTo(map);
      } else {
        map.removeLayer(lyr);
      }
    });

    rng.addEventListener("input", e => {
      overlayLayers[e.target.dataset.id].setOpacity(parseFloat(e.target.value));
    });
  });
</script>
